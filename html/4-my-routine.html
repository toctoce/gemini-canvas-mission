<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì†Œí•œ ì£¼ê°„ ë£¨í‹´ ğŸŒ±</title>
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•´ ì‚¬ìš©) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (ì•„ì´ì½˜) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- íŒ¡íŒŒë ˆ ì• ë‹ˆë©”ì´ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ ğŸ‰ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f2fbf5',
                            100: '#e1f6e8',
                            200: '#c4ebd3',
                            300: '#9ad8b5',
                            400: '#69be90',
                            500: '#42a272',
                            600: '#308159',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                        handwriting: ['"Nanum Pen Script"', 'cursive'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #faf9f7;
            color: #333;
        }
        
        .routine-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        
        .routine-checkbox:checked {
            background-color: #42a272;
            border-color: #42a272;
        }
        
        .routine-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .completed-text {
            text-decoration: line-through;
            color: #94a3b8;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .day-btn.active {
            background-color: #42a272;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        
        .day-btn {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="text-center mb-8 relative">
            <div class="absolute left-0 top-0">
                <button id="nav-profile-btn" class="bg-white border border-brand-200 text-brand-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-brand-50 transition-colors flex items-center gap-2">
                    <i class="fas fa-user-cog"></i> í”„ë¡œí•„ ì„¤ì •
                </button>
            </div>
            <div class="absolute right-0 top-0">
                <button id="nav-friends-btn" class="bg-white border border-brand-200 text-brand-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-brand-50 transition-colors flex items-center gap-2">
                    <i class="fas fa-users"></i> ì¹œêµ¬ë“¤ êµ¬ê²½í•˜ê¸°
                </button>
                <button id="nav-personal-btn" class="hidden bg-white border border-brand-200 text-brand-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-brand-50 transition-colors flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> ë‚´ ë£¨í‹´ìœ¼ë¡œ
                </button>
            </div>
            <h1 class="text-4xl font-handwriting text-brand-600 mb-2">ğŸŒ± ë‚˜ì˜ ì†Œì†Œí•œ ì£¼ê°„ ë£¨í‹´</h1>
            <p class="text-gray-500 font-medium" id="greeting-msg">ì˜¤ëŠ˜ë„ ì¡°ê¸ˆì”©, ë‚˜ë§Œì˜ ì†ë„ë¡œ ë‚˜ì•„ê°€ìš”! ğŸ¢</p>
        </header>

        <!-- ë‚´ ë£¨í‹´ í™”ë©´ -->
        <div id="view-personal" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 space-y-6">
                <!-- ë£¨í‹´ ì¶”ê°€ í¼ -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-brand-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-brand-400"></div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-seedling text-brand-500"></i> ìƒˆë¡œìš´ ë£¨í‹´ ì‹¬ê¸°
                    </h3>
                    <form id="add-routine-form">
                        <div class="flex bg-gray-100 p-1 rounded-lg mb-4">
                            <button type="button" id="type-day-btn" class="flex-1 py-2 text-sm font-medium bg-white shadow-sm rounded-md text-brand-600 transition-all">ğŸ“ íŠ¹ì • ìš”ì¼ ì§€ì •</button>
                            <button type="button" id="type-freq-btn" class="flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-md transition-all">ğŸ¯ ì£¼ê°„ íšŸìˆ˜ ì§€ì •</button>
                        </div>
                        <input type="text" id="routine-input" placeholder="ìƒˆë¡œìš´ ë£¨í‹´ì„ ì ì–´ì£¼ì„¸ìš” (ì˜ˆ: ë¬¼ 1ì” ë§ˆì‹œê¸°)" class="bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl focus:ring-brand-500 focus:border-brand-500 block w-full p-3 transition-colors outline-none mb-4" required>
                        
                        <div id="day-selection-area">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">ì–¸ì œ ì‹¤ì²œí• ê¹Œìš”?</span>
                                <button type="button" id="select-all-days" class="text-xs text-brand-600 hover:text-brand-700 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg transition-colors font-medium">ë§¤ì¼ ì„ íƒí•˜ê¸°</button>
                            </div>
                            <div class="flex justify-between sm:justify-start sm:gap-3" id="day-checkboxes">
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="ì›”" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500 border border-gray-200 peer-checked:bg-brand-500 peer-checked:text-white peer-checked:border-brand-500 transition-all font-medium hover:bg-gray-100">ì›”</div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="í™”" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500 border border-gray-200 peer-checked:bg-brand-500 peer-checked:text-white peer-checked:border-brand-500 transition-all font-medium hover:bg-gray-100">í™”</div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="ìˆ˜" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500 border border-gray-200 peer-checked:bg-brand-500 peer-checked:text-white peer-checked:border-brand-500 transition-all font-medium hover:bg-gray-100">ìˆ˜</div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="ëª©" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500 border border-gray-200 peer-checked:bg-brand-500 peer-checked:text-white peer-checked:border-brand-500 transition-all font-medium hover:bg-gray-100">ëª©</div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="ê¸ˆ" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-500 border border-gray-200 peer-checked:bg-brand-500 peer-checked:text-white peer-checked:border-brand-500 transition-all font-medium hover:bg-gray-100">ê¸ˆ</div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="í† " class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-50 text-blue-500 border border-blue-100 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all font-medium hover:bg-blue-100">í† </div></label>
                                <label class="cursor-pointer"><input type="checkbox" name="routine-days" value="ì¼" class="peer sr-only"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-red-50 text-red-500 border border-red-100 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition-all font-medium hover:bg-red-100">ì¼</div></label>
                            </div>
                            <p id="day-warning-msg" class="text-sm text-red-500 mt-3 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i> ì‹¤ì²œí•  ìš”ì¼ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸŒ±</p>
                        </div>
                        
                        <div id="freq-selection-area" class="hidden">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">ì´ë²ˆ ì£¼ì— ëª‡ ë²ˆ ì‹¤ì²œí• ê¹Œìš”?</span>
                            </div>
                            <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl border border-gray-100 justify-center">
                                <button type="button" onclick="changeFreq(-1)" class="w-10 h-10 rounded-full bg-white border border-gray-200 hover:bg-gray-100 flex items-center justify-center text-gray-600 shadow-sm transition-colors"><i class="fas fa-minus"></i></button>
                                <div class="text-center w-20">
                                    <span id="freq-display" class="text-2xl font-bold text-brand-600">3</span><span class="text-gray-500 ml-1">íšŒ</span>
                                </div>
                                <button type="button" onclick="changeFreq(1)" class="w-10 h-10 rounded-full bg-brand-100 hover:bg-brand-200 border border-brand-200 flex items-center justify-center text-brand-600 shadow-sm transition-colors"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        
                        <button type="submit" class="mt-5 w-full bg-brand-500 hover:bg-brand-600 text-white font-medium rounded-xl py-3.5 transition-colors shadow-sm flex items-center justify-center gap-2 text-base">
                            <i class="fas fa-plus"></i> ë£¨í‹´ ì¶”ê°€í•˜ê¸°
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center space-x-2 overflow-x-auto pb-2" id="day-selector"></div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 min-h-[300px] flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <span id="current-day-title">ì›”ìš”ì¼</span>
                            <span class="text-sm font-normal text-brand-500 bg-brand-50 px-3 py-1 rounded-full" id="day-progress-text">0/0 ì™„ë£Œ</span>
                        </h2>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <ul id="routine-list" class="space-y-3"></ul>
                        <div id="empty-state" class="hidden flex-col items-center justify-center h-full text-center py-10 opacity-60">
                            <div class="text-6xl mb-4">ğŸ“</div>
                            <p class="text-gray-500">ì•„ì§ ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ì–´ìš”.<br>ìœ„ì—ì„œ ìƒˆë¡œìš´ ë£¨í‹´ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center">
                    <h3 class="text-lg font-bold text-gray-800 mb-6">ì´ë²ˆ ì£¼ ë‹¬ì„±ë„ ğŸ†</h3>
                    <div class="relative w-48 h-48 mx-auto flex items-center justify-center">
                        <svg class="w-full h-full" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#f1f5f9" stroke-width="12"></circle>
                            <circle id="progress-circle" class="progress-ring__circle" cx="60" cy="60" r="50" fill="none" stroke="#42a272" stroke-width="12" stroke-linecap="round" stroke-dasharray="314.159" stroke-dashoffset="314.159"></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="weekly-percentage" class="text-3xl font-bold text-gray-800">0%</span>
                            <span class="text-xs text-gray-500 mt-1" id="weekly-fraction">0 / 0</span>
                        </div>
                    </div>
                    <p id="weekly-message" class="mt-6 text-sm font-medium text-gray-600 bg-gray-50 py-2 rounded-lg">ì‹œì‘ì´ ë°˜ì´ì—ìš”! ì‘ì›í•©ë‹ˆë‹¤ âœ¨</p>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-bullseye text-brand-500"></i> ì£¼ê°„ ë°˜ë³µ ëª©í‘œ
                    </h3>
                    <ul id="flexible-routine-list" class="space-y-3"></ul>
                    <div id="flex-empty-state" class="text-center py-6 text-sm text-gray-400 bg-gray-50 rounded-xl">
                        ë“±ë¡ëœ ì£¼ê°„ ëª©í‘œê°€ ì—†ì–´ìš”.<br>ìœ„ì—ì„œ 'ì£¼ê°„ íšŸìˆ˜ ì§€ì •'ìœ¼ë¡œ ì¶”ê°€í•´ë³´ì„¸ìš”!
                    </div>
                </div>

                <div class="bg-brand-50 rounded-2xl p-5 border border-brand-100">
                    <h4 class="font-bold text-brand-600 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-yellow-500"></i> í¬ê·¼í•œ íŒ
                    </h4>
                    <p class="text-sm text-gray-600 leading-relaxed">
                        ë£¨í‹´ ê´€ë¦¬ê°€ ì–´ë µë‹¤ë©´, <b>'ì•„ì¹¨ì— ì¼ì–´ë‚˜ì„œ ê¸°ì§€ê°œ ì¼œê¸°'</b>ì²˜ëŸ¼ 1ë¶„ ì•ˆì— í•  ìˆ˜ ìˆëŠ” ì•„ì£¼ ì‘ê³  ì‰¬ìš´ ëª©í‘œë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”. ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”! ğŸ’–
                    </p>
                </div>
                
                <button id="reset-week-btn" class="w-full py-3 text-sm text-red-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                    ì´ë²ˆ ì£¼ ë£¨í‹´ ì´ˆê¸°í™”í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ë§ˆì´í˜ì´ì§€(í”„ë¡œí•„) í™”ë©´ -->
        <div id="view-profile" class="hidden space-y-6 max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-brand-100">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-id-card text-brand-500 mr-2"></i>ë‚˜ë§Œì˜ í”„ë¡œí•„ ê¾¸ë¯¸ê¸° ğŸ¨</h2>
                    <p class="text-gray-500 text-sm mt-2">ì¹œêµ¬ë“¤ì—ê²Œ ë³´ì—¬ì§ˆ ë‚˜ì˜ ëª¨ìŠµì„ ì„¤ì •í•´ ë³´ì„¸ìš”!</p>
                </div>
                
                <div class="space-y-8">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">ì–´ë–¤ ëª¨ìŠµìœ¼ë¡œ ë³´ì—¬ì§ˆê¹Œìš”?</label>
                        <div id="emoji-selector" class="flex flex-wrap gap-3 justify-center sm:justify-start"></div>
                    </div>

                    <div>
                        <label for="profile-nickname-input" class="block text-sm font-bold text-gray-700 mb-2">ë‚˜ì˜ ë‹‰ë„¤ì„</label>
                        <input type="text" id="profile-nickname-input" placeholder="ë”°ëœ»í•œ ë‹¤ëŒì¥" class="bg-gray-50 border border-gray-200 text-gray-900 text-base rounded-xl focus:ring-brand-500 focus:border-brand-500 block w-full p-3.5 transition-colors outline-none" maxlength="12">
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-3">
                            <label class="block text-sm font-bold text-gray-700">ìë‘í•˜ê³  ì‹¶ì€ ëŒ€í‘œ ë£¨í‹´ <span class="text-brand-500 font-normal text-xs ml-1">(ìµœëŒ€ 3ê°œ)</span></label>
                            <span id="selected-routine-count" class="text-xs font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded-md">0 / 3</span>
                        </div>
                        <div id="profile-routines-container" class="bg-gray-50 border border-gray-100 rounded-xl p-4 max-h-60 overflow-y-auto space-y-2"></div>
                    </div>

                    <button id="save-profile-btn" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-xl py-4 transition-transform active:scale-95 shadow-sm shadow-brand-200 text-lg flex items-center justify-center gap-2 mt-4">
                        <i class="fas fa-check"></i> í”„ë¡œí•„ ì €ì¥í•˜ê¸°
                    </button>
                    
                    <!-- ğŸ’¡ ë¬¸ì œ ì›ì¸ì„ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ë‚´ UIDë¥¼ ì‚´ì§ ë³´ì—¬ì£¼ëŠ” ë””ë²„ê¹… ìš”ì†Œ ì¶”ê°€! -->
                    <p class="text-xs text-gray-400 mt-6 text-center">
                        <i class="fas fa-key mr-1"></i> ë‚´ ê³ ìœ  ID (UID): <span id="debug-uid" class="font-mono bg-gray-100 px-1 rounded text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- ì¹œêµ¬ë“¤ ë£¨í‹´ í™”ë©´ -->
        <div id="view-friends" class="hidden space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-brand-100">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-users text-brand-500 mr-2"></i>ë”°ëœ»í•œ ì¹œêµ¬ë“¤ì˜ ë£¨í‹´ ğŸ’›</h2>
                </div>
                
                <div id="friends-loading" class="text-center py-10 text-brand-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="mt-2 text-sm font-medium">ì¹œêµ¬ë“¤ì˜ ë£¨í‹´ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”...</p>
                </div>

                <div id="friends-list" class="flex flex-wrap justify-center gap-6 sm:gap-8 pt-4 pb-20 hidden"></div>
                
                <div id="friends-empty" class="hidden text-center py-12 text-gray-400 bg-gray-50 rounded-xl">
                    <i class="fas fa-seedling text-3xl mb-3 text-gray-300"></i>
                    <p>ì•„ì§ ë£¨í‹´ì„ ê³µìœ í•œ ì¹œêµ¬ê°€ ì—†ì–´ìš”.<br>ë‚´ê°€ ë¨¼ì € ë£¨í‹´ì„ ì‹¤ì²œí•˜ê³  ê³µìœ í•´ ë³¼ê¹Œìš”?</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (ì´ˆê¸°í™” í™•ì¸ìš©) -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-xl border border-brand-100 transform transition-transform scale-100">
            <div class="w-12 h-12 rounded-full bg-red-50 text-red-500 flex items-center justify-center text-xl mb-4 mx-auto">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? ğŸ”„</h3>
            <p class="text-gray-500 text-sm mb-6 text-center leading-relaxed">ì´ë²ˆ ì£¼ ë‹¬ì„± ê¸°ë¡ì´ ëª¨ë‘ 0%ë¡œ ì´ˆê¸°í™”ë¼ìš”.<br>ë“±ë¡í•´ë‘” ë£¨í‹´ ëª©ë¡ì€ ì§€ì›Œì§€ì§€ ì•Šì•„ìš”!</p>
            <div class="flex gap-3">
                <button id="modal-cancel-btn" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition-colors">ì•„ë‹ˆìš”, ì·¨ì†Œ</button>
                <button id="modal-confirm-btn" class="flex-1 py-3 bg-red-400 text-white rounded-xl font-medium hover:bg-red-500 transition-colors shadow-sm shadow-red-200">ë„¤, ì´ˆê¸°í™”í• ê²Œìš”</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ì´ˆê¸°í™” ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let currentUser = null;
        let unsubscribeSnapshot = null;
        let unsubscribeFriends = null;

        // --- ìƒíƒœ ê´€ë¦¬ ---
        const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
        const todayIdx = new Date().getDay(); 
        let currentDayIdx = todayIdx === 0 ? 6 : todayIdx - 1; 

        let routines = {};
        days.forEach(day => routines[day] = []);
        let flexRoutines = []; 
        let currentRoutineType = 'day'; 
        let currentFreq = 3;
        let hasCelebrated = false; 
        let lastResetTime = 0; 
        
        // --- ì¹œêµ¬ ê¸°ëŠ¥ ë° í”„ë¡œí•„ ìƒíƒœ ê´€ë¦¬ ---
        let myNickname = "";
        let myEmoji = "ğŸŒ±"; 
        let selectedPreviewRoutines = []; 
        let friendsData = [];

        const availableEmojis = ['ğŸŒ±', 'ğŸ°', 'ğŸ¿ï¸', 'ğŸ±', 'ğŸ¶', 'ğŸ»', 'ğŸ¹', 'ğŸ¥', 'ğŸ¦¦', 'ğŸ¢', 'ğŸ¦Š', 'ğŸ€', 'ğŸ', 'ğŸŒ™'];

        const adjectives = ['í–‰ë³µí•œ', 'ë”°ëœ»í•œ', 'í¬ê·¼í•œ', 'ì”©ì”©í•œ', 'ë‹¤ì •í•œ', 'ê·€ì—¬ìš´', 'ë¶€ì§€ëŸ°í•œ', 'ë‹¤ë¶€ì§„', 'ëª…ë‘í•œ'];
        const animals = ['í† ë¼', 'ë‹¤ëŒì¥', 'ê³ ì–‘ì´', 'ê°•ì•„ì§€', 'ê±°ë¶ì´', 'ê³°ëŒì´', 'ë³‘ì•„ë¦¬', 'ì•ŒíŒŒì¹´', 'ìˆ˜ë‹¬'];
        function generateNickname() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const ani = animals[Math.floor(Math.random() * animals.length)];
            return `${adj} ${ani}`;
        }

        // --- í´ë¼ìš°ë“œ ì¸ì¦ ë° ë°ì´í„° ì—°ë™ ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("ì¸ì¦ ì—ëŸ¬ê°€ ë°œìƒí–ˆì–´ìš”:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // ë””ë²„ê¹… UI: í˜„ì¬ ë‚´ UID ë³´ì—¬ì£¼ê¸°
                const uidDisplay = document.getElementById('debug-uid');
                if (uidDisplay) uidDisplay.textContent = user.uid;
                
                loadDataFromCloud();
                loadFriendsData(); // ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰!
            } else {
                currentUser = null;
                if (unsubscribeSnapshot) unsubscribeSnapshot();
                if (unsubscribeFriends) unsubscribeFriends();
            }
        });

        function loadDataFromCloud() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'app_data', 'weekly_routines');
            
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                const now = new Date();
                const dayOfWeek = now.getDay(); 
                const daysSinceMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                const currentMonday = new Date(now);
                currentMonday.setDate(now.getDate() - daysSinceMonday);
                currentMonday.setHours(0, 0, 0, 0);
                const currentMondayTime = currentMonday.getTime();

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    routines = data.routines || {};
                    flexRoutines = data.flexRoutines || [];
                    lastResetTime = data.lastResetTime || 0;
                    myNickname = data.nickname || generateNickname();
                    myEmoji = data.emoji || availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
                    selectedPreviewRoutines = data.selectedPreviewRoutines || [];

                    if (lastResetTime < currentMondayTime) {
                        days.forEach(day => {
                            if (routines[day]) {
                                routines[day].forEach(r => r.completed = false);
                            }
                        });
                        flexRoutines.forEach(r => r.completed = 0);
                        lastResetTime = currentMondayTime; 
                        saveData(); 
                    }
                } else {
                    days.forEach(day => routines[day] = []);
                    flexRoutines = [];
                    lastResetTime = currentMondayTime;
                    myNickname = generateNickname();
                    myEmoji = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
                    selectedPreviewRoutines = [];
                }
                
                days.forEach(day => { if (!routines[day]) routines[day] = []; });

                renderDaySelector();
                renderRoutineList();
                renderFlexRoutineList();
                updateVisualization();
                
            }, (error) => {
                console.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”:", error);
            });
        }

        function loadFriendsData() {
            if (!currentUser) return;
            
            const friendsRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_routines');
            
            if (unsubscribeFriends) unsubscribeFriends();
            
            unsubscribeFriends = onSnapshot(friendsRef, (snapshot) => {
                friendsData = [];
                snapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) { // ë‚´ ë°ì´í„°(ë‚´ UID)ëŠ” ì¹œêµ¬ ëª©ë¡ì—ì„œ ì œì™¸!
                        friendsData.push({ id: doc.id, ...doc.data() });
                    }
                });
                
                friendsData.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                
                // ğŸ’¡ ê°œë°œì ë„êµ¬ ì½˜ì†”ì— JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì˜ˆì˜ê²Œ ë¿Œë ¤ì¤ë‹ˆë‹¤!
                console.log("=========================================");
                console.log("â˜ï¸ ë°©ê¸ˆ ë¶ˆëŸ¬ì˜¨ [ì¹œêµ¬ë“¤ í¼ë¸”ë¦­ ë°ì´í„°] JSON í˜•ì‹:");
                console.log(JSON.stringify(friendsData, null, 2));
                console.log("=========================================");

                renderFriendsList();
            }, (error) => {
                console.error("ì¹œêµ¬ë“¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”:", error);
                document.getElementById('friends-loading').classList.add('hidden');
            });
        }

        async function saveData() {
            updateVisualization(); 
            if (!currentUser) return;
            
            const privateDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'app_data', 'weekly_routines');
            const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_routines', currentUser.uid);
            
            let totalTasks = 0; let totalCompleted = 0;
            days.forEach(day => {
                const dayData = routines[day] || [];
                totalTasks += dayData.length;
                totalCompleted += dayData.filter(r => r.completed).length;
            });
            flexRoutines.forEach(r => {
                totalTasks += r.target;
                totalCompleted += r.completed;
            });
            const percentage = totalTasks === 0 ? 0 : Math.round((totalCompleted / totalTasks) * 100);

            try {
                await setDoc(privateDocRef, {
                    routines: routines,
                    flexRoutines: flexRoutines,
                    lastResetTime: lastResetTime,
                    nickname: myNickname,
                    emoji: myEmoji,
                    selectedPreviewRoutines: selectedPreviewRoutines,
                    updatedAt: Date.now()
                }, { merge: true });
                
                let previewToSave = selectedPreviewRoutines;
                if (previewToSave.length === 0) {
                    previewToSave = days.map(d => routines[d]).flat().slice(0, 3).map(r => r.text);
                }

                const publicDataObj = {
                    nickname: myNickname,
                    emoji: myEmoji,
                    percentage: percentage,
                    routinesPreview: previewToSave, 
                    updatedAt: Date.now()
                };

                await setDoc(publicDocRef, publicDataObj, { merge: true });

                // ğŸ’¡ ì½˜ì†”ì—ì„œ ë‚´ í¼ë¸”ë¦­ ë°ì´í„°ê°€ ì–´ë–»ê²Œ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸!
                console.log("â˜ï¸ [ë‚´ í¼ë¸”ë¦­ í”„ë¡œí•„] í´ë¼ìš°ë“œì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë¨:");
                console.log(JSON.stringify(publicDataObj, null, 2));

            } catch (error) {
                console.error("ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”:", error);
            }
        }

        // --- UI ë Œë”ë§ í•¨ìˆ˜ë“¤ ---

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = '';

            days.forEach((day, index) => {
                const dayData = routines[day] || [];
                const total = dayData.length;
                const completed = dayData.filter(r => r.completed).length;
                
                const isAllDone = total > 0 && total === completed;

                const btn = document.createElement('button');
                btn.className = `day-btn flex-1 flex flex-col items-center py-3 px-2 rounded-xl text-sm font-medium ${index === currentDayIdx ? 'active' : 'text-gray-500 hover:bg-gray-50'}`;
                btn.onclick = () => {
                    currentDayIdx = index;
                    renderDaySelector();
                    renderRoutineList();
                };

                btn.innerHTML = `
                    <span class="mb-1">${day}</span>
                    <div class="flex gap-0.5">
                        ${total === 0 ? '<span class="w-1.5 h-1.5 rounded-full bg-gray-200"></span>' : ''}
                        ${total > 0 && isAllDone ? '<i class="fas fa-star text-yellow-300 text-[10px]"></i>' : ''}
                        ${total > 0 && !isAllDone ? '<span class="w-1.5 h-1.5 rounded-full bg-brand-200"></span>' : ''}
                    </div>
                `;
                container.appendChild(btn);
            });
        }

        function renderRoutineList() {
            const selectedDay = days[currentDayIdx];
            const dayRoutines = routines[selectedDay] || [];
            
            document.getElementById('current-day-title').textContent = `${selectedDay}ìš”ì¼`;
            
            const listContainer = document.getElementById('routine-list');
            const emptyState = document.getElementById('empty-state');
            
            listContainer.innerHTML = '';

            if (dayRoutines.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                
                const sortedRoutines = [...dayRoutines].sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);

                sortedRoutines.forEach(routine => {
                    const li = document.createElement('li');
                    li.className = `flex items-center justify-between p-4 rounded-xl border ${routine.completed ? 'bg-gray-50 border-gray-100' : 'bg-white border-gray-200 shadow-sm'} transition-all`;
                    
                    li.innerHTML = `
                        <div class="flex items-center gap-4 flex-1 cursor-pointer" onclick="window.toggleRoutine(${routine.id})">
                            <input type="checkbox" class="routine-checkbox flex-shrink-0" ${routine.completed ? 'checked' : ''} onclick="event.stopPropagation(); window.toggleRoutine(${routine.id})">
                            <span class="text-base font-medium ${routine.completed ? 'completed-text' : 'text-gray-800'} transition-all flex-1 select-none">${routine.text}</span>
                        </div>
                        <button onclick="window.deleteRoutine(${routine.id})" class="text-gray-300 hover:text-red-400 p-2 rounded-lg transition-colors ml-2" title="ì‚­ì œ">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listContainer.appendChild(li);
                });
            }

            const completedCount = dayRoutines.filter(r => r.completed).length;
            document.getElementById('day-progress-text').textContent = `${completedCount}/${dayRoutines.length} ì™„ë£Œ`;
            
            updateVisualization();
            renderFlexRoutineList();
        }

        function renderFlexRoutineList() {
            const listContainer = document.getElementById('flexible-routine-list');
            const emptyState = document.getElementById('flex-empty-state');
            
            listContainer.innerHTML = '';
            
            if (flexRoutines.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                flexRoutines.forEach(routine => {
                    const isCompleted = routine.completed >= routine.target;
                    const li = document.createElement('li');
                    li.className = `p-4 rounded-xl border transition-all ${isCompleted ? 'bg-brand-50 border-brand-100' : 'bg-white border-gray-200 shadow-sm'}`;
                    
                    const progressPercent = (routine.completed / routine.target) * 100;
                    
                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium ${isCompleted ? 'text-brand-600' : 'text-gray-800'}">${routine.text}</span>
                            <span class="text-sm font-bold ${isCompleted ? 'text-brand-500' : 'text-gray-500'}">${routine.completed} / ${routine.target}íšŒ</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-brand-400 transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                            <button onclick="window.changeFlexComplete(${routine.id}, 1)" class="w-8 h-8 rounded-full border border-brand-200 text-brand-500 flex items-center justify-center hover:bg-brand-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${isCompleted ? 'disabled' : ''} title="1íšŒ ì™„ë£Œí•˜ê¸°">
                                <i class="fas fa-check text-xs"></i>
                            </button>
                            <button onclick="window.changeFlexComplete(${routine.id}, -1)" class="w-8 h-8 rounded-full border border-gray-200 text-gray-400 flex items-center justify-center hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" ${routine.completed === 0 ? 'disabled' : ''} title="ì‹¤í–‰ ì·¨ì†Œ">
                                <i class="fas fa-undo text-xs"></i>
                            </button>
                            <button onclick="window.deleteFlexRoutine(${routine.id})" class="text-gray-300 hover:text-red-400 ml-1 p-1">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(li);
                });
            }
        }

        function renderFriendsList() {
            const listContainer = document.getElementById('friends-list');
            const loadingState = document.getElementById('friends-loading');
            const emptyState = document.getElementById('friends-empty');
            
            loadingState.classList.add('hidden');
            
            if (friendsData.length === 0) {
                listContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = '';
            
            friendsData.forEach(friend => {
                const percent = friend.percentage || 0;
                const routinesPreview = friend.routinesPreview || [];
                
                const radius = 44;
                const circumference = 2 * Math.PI * radius; 
                const offset = circumference - (percent / 100) * circumference;
                
                let avatarHtml = '';
                if (friend.emoji) {
                    avatarHtml = `<span class="text-3xl">${friend.emoji}</span>`;
                } else {
                    const nameParts = (friend.nickname || 'ìµëª…').split(' ');
                    const avatarText = nameParts.length > 1 ? nameParts[1].substring(0, 2) : nameParts[0].substring(0, 2);
                    avatarHtml = `<span class="text-lg font-bold text-brand-600">${avatarText}</span>`;
                }
                
                let routinesHtml = '';
                if (routinesPreview.length > 0) {
                    routinesHtml = `<ul class="text-xs text-gray-600 space-y-2 text-left w-full mt-2">`;
                    routinesPreview.forEach(r => {
                        routinesHtml += `<li class="flex items-start gap-1.5 leading-snug"><i class="fas fa-check text-brand-400 mt-0.5"></i> <span class="flex-1 break-all">${r}</span></li>`;
                    });
                    routinesHtml += `</ul>`;
                } else {
                    routinesHtml = `<p class="text-xs text-gray-400 text-center py-4">ì•„ì§ ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ì–´ìš” ğŸŒ±</p>`;
                }
                
                const div = document.createElement('div');
                div.className = 'relative flex flex-col items-center group';
                div.innerHTML = `
                    <div class="relative w-24 h-24 cursor-pointer transform transition-transform hover:scale-105 active:scale-95 z-10" onclick="window.toggleFriendDetails('${friend.id}')">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="44" fill="none" stroke="#f1f5f9" stroke-width="6"></circle>
                            <circle cx="50" cy="50" r="44" fill="none" stroke="#42a272" stroke-width="6" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" class="transition-all duration-1000"></circle>
                        </svg>
                        <div class="absolute inset-0 m-2.5 bg-brand-50 rounded-full flex items-center justify-center shadow-inner border border-white">
                            ${avatarHtml}
                        </div>
                    </div>
                    
                    <span class="mt-2 text-sm font-bold text-gray-700">${friend.nickname || 'ìµëª…'}</span>
                    <span class="text-xs font-bold ${percent === 100 ? 'text-brand-500' : 'text-gray-400'}">${percent}%</span>
                    
                    <div id="friend-details-${friend.id}" class="hidden absolute top-full mt-2 w-52 bg-white border border-brand-100 shadow-[0_8px_30px_rgb(0,0,0,0.08)] rounded-2xl p-4 z-20">
                        <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white border-t border-l border-brand-100 rotate-45"></div>
                        <div class="relative z-10 flex flex-col items-center">
                            <span class="text-[11px] font-bold text-brand-500 mb-1 border-b border-brand-50 w-full text-center pb-2">ëŒ€í‘œ ë£¨í‹´ ì—¿ë³´ê¸° ğŸ‘€</span>
                            ${routinesHtml}
                        </div>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        window.toggleFriendDetails = function(id) {
            document.querySelectorAll('[id^="friend-details-"]').forEach(el => {
                if (el.id !== `friend-details-${id}`) {
                    el.classList.add('hidden');
                }
            });
            
            const detailsDiv = document.getElementById(`friend-details-${id}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        };

        function renderProfileSettings() {
            document.getElementById('profile-nickname-input').value = myNickname;

            const emojiContainer = document.getElementById('emoji-selector');
            emojiContainer.innerHTML = '';
            availableEmojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = `w-12 h-12 text-2xl rounded-full flex items-center justify-center transition-all ${myEmoji === emoji ? 'bg-brand-100 ring-2 ring-brand-400 transform scale-110 shadow-sm' : 'bg-gray-50 hover:bg-gray-100 grayscale-[0.5] hover:grayscale-0'}`;
                btn.onclick = () => {
                    myEmoji = emoji;
                    renderProfileSettings(); 
                };
                btn.innerText = emoji;
                emojiContainer.appendChild(btn);
            });

            const routineContainer = document.getElementById('profile-routines-container');
            routineContainer.innerHTML = '';
            
            const allMyRoutines = new Set();
            days.forEach(day => {
                const dayRoutines = routines[day] || [];
                dayRoutines.forEach(r => allMyRoutines.add(r.text));
            });
            flexRoutines.forEach(r => allMyRoutines.add(r.text));
            const uniqueRoutines = Array.from(allMyRoutines);

            if (uniqueRoutines.length === 0) {
                routineContainer.innerHTML = `<p class="text-center py-6 text-sm text-gray-400">ì•„ì§ ë“±ë¡ëœ ë£¨í‹´ì´ ì—†ì–´ìš”.<br>ë£¨í‹´ì„ ë¨¼ì € ì¶”ê°€í•´ ì£¼ì„¸ìš”!</p>`;
            } else {
                uniqueRoutines.forEach((text, index) => {
                    const isSelected = selectedPreviewRoutines.includes(text);
                    const isDisabled = !isSelected && selectedPreviewRoutines.length >= 3;

                    const label = document.createElement('label');
                    label.className = `flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-colors ${isSelected ? 'bg-brand-50 border-brand-200' : 'bg-white border-gray-200 hover:bg-gray-50'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                    
                    label.innerHTML = `
                        <input type="checkbox" class="w-5 h-5 text-brand-500 rounded border-gray-300 focus:ring-brand-500" 
                               value="${text}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <span class="text-sm text-gray-700 font-medium">${text}</span>
                    `;

                    const checkbox = label.querySelector('input');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            if (selectedPreviewRoutines.length < 3) {
                                selectedPreviewRoutines.push(text);
                            }
                        } else {
                            selectedPreviewRoutines = selectedPreviewRoutines.filter(r => r !== text);
                        }
                        renderProfileSettings(); 
                    });

                    routineContainer.appendChild(label);
                });
            }

            document.getElementById('selected-routine-count').innerText = `${selectedPreviewRoutines.length} / 3`;
        }

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const newName = document.getElementById('profile-nickname-input').value.trim();
            if (newName) {
                myNickname = newName;
            }
            
            const btn = document.getElementById('save-profile-btn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ì €ì¥í•˜ëŠ” ì¤‘...`;
            
            await saveData();
            
            btn.innerHTML = `<i class="fas fa-check-circle"></i> ì˜ˆì˜ê²Œ ì €ì¥ëì–´ìš”!`;
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                document.getElementById('nav-personal-btn').click();
            }, 1500);
        });

        // --- í™”ë©´ ì „í™˜ ë¡œì§ ---
        const navProfileBtn = document.getElementById('nav-profile-btn');
        const navFriendsBtn = document.getElementById('nav-friends-btn');
        const navPersonalBtn = document.getElementById('nav-personal-btn');
        
        const viewPersonal = document.getElementById('view-personal');
        const viewFriends = document.getElementById('view-friends');
        const viewProfile = document.getElementById('view-profile');

        function switchView(target) {
            viewPersonal.classList.add('hidden');
            viewFriends.classList.add('hidden');
            viewProfile.classList.add('hidden');
            
            navProfileBtn.classList.add('hidden');
            navFriendsBtn.classList.add('hidden');
            navPersonalBtn.classList.add('hidden');

            if (target === 'personal') {
                viewPersonal.classList.remove('hidden');
                navProfileBtn.classList.remove('hidden');
                navFriendsBtn.classList.remove('hidden');
            } else if (target === 'friends') {
                viewFriends.classList.remove('hidden');
                navPersonalBtn.classList.remove('hidden');
            } else if (target === 'profile') {
                viewProfile.classList.remove('hidden');
                navPersonalBtn.classList.remove('hidden');
                renderProfileSettings(); 
            }
        }

        navProfileBtn.addEventListener('click', () => switchView('profile'));
        navFriendsBtn.addEventListener('click', () => switchView('friends'));
        navPersonalBtn.addEventListener('click', () => switchView('personal'));

        // --- ë™ì‘ í•¨ìˆ˜ë“¤ ---
        const typeDayBtn = document.getElementById('type-day-btn');
        const typeFreqBtn = document.getElementById('type-freq-btn');
        const dayArea = document.getElementById('day-selection-area');
        const freqArea = document.getElementById('freq-selection-area');

        typeDayBtn.addEventListener('click', () => {
            currentRoutineType = 'day';
            typeDayBtn.className = 'flex-1 py-2 text-sm font-medium bg-white shadow-sm rounded-md text-brand-600 transition-all';
            typeFreqBtn.className = 'flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-md transition-all';
            dayArea.classList.remove('hidden');
            freqArea.classList.add('hidden');
        });

        typeFreqBtn.addEventListener('click', () => {
            currentRoutineType = 'freq';
            typeFreqBtn.className = 'flex-1 py-2 text-sm font-medium bg-white shadow-sm rounded-md text-brand-600 transition-all';
            typeDayBtn.className = 'flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-md transition-all';
            freqArea.classList.remove('hidden');
            dayArea.classList.add('hidden');
        });

        window.changeFreq = function(amount) {
            currentFreq += amount;
            if (currentFreq < 1) currentFreq = 1;
            if (currentFreq > 21) currentFreq = 21;
            document.getElementById('freq-display').textContent = currentFreq;
        };

        document.getElementById('select-all-days').addEventListener('click', function() {
            document.querySelectorAll('input[name="routine-days"]').forEach(cb => cb.checked = true);
            document.getElementById('day-warning-msg').classList.add('hidden');
        });

        document.querySelectorAll('input[name="routine-days"]').forEach(cb => {
            cb.addEventListener('change', () => {
                document.getElementById('day-warning-msg').classList.add('hidden');
            });
        });

        document.getElementById('add-routine-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('routine-input');
            const text = input.value.trim();
            const warningMsg = document.getElementById('day-warning-msg');
            
            if (!text) return;

            if (currentRoutineType === 'day') {
                const selectedDayInputs = document.querySelectorAll('input[name="routine-days"]:checked');
                
                if (selectedDayInputs.length === 0) {
                    warningMsg.classList.remove('hidden');
                    return;
                }

                const newRoutineTemplate = { text: text, completed: false };

                selectedDayInputs.forEach(dayInput => {
                    const day = dayInput.value;
                    routines[day].push({ ...newRoutineTemplate, id: Date.now() + Math.random() });
                });
                
                document.querySelectorAll('input[name="routine-days"]').forEach(cb => cb.checked = false);
            } else {
                flexRoutines.push({
                    id: Date.now(),
                    text: text,
                    target: currentFreq,
                    completed: 0
                });
                currentFreq = 3;
                document.getElementById('freq-display').textContent = currentFreq;
            }

            input.value = ''; 
            
            saveData();
            renderDaySelector();
            renderRoutineList();
            renderFlexRoutineList();
            
            input.placeholder = "ë£¨í‹´ì´ ì˜ ì¶”ê°€ë˜ì—ˆì–´ìš”! âœ¨ ë˜ ì¶”ê°€í• ê¹Œìš”?";
            setTimeout(() => input.placeholder = "ìƒˆë¡œìš´ ë£¨í‹´ì„ ì ì–´ì£¼ì„¸ìš” (ì˜ˆ: ë¬¼ 1ì” ë§ˆì‹œê¸°)", 2000);
        });

        window.toggleRoutine = function(id) {
            const selectedDay = days[currentDayIdx];
            const routine = routines[selectedDay].find(r => r.id === id);
            if (routine) {
                routine.completed = !routine.completed;
                saveData();
                renderDaySelector();
                renderRoutineList();
            }
        };

        window.deleteRoutine = function(id) {
            const selectedDay = days[currentDayIdx];
            routines[selectedDay] = routines[selectedDay].filter(r => r.id !== id);
            saveData();
            renderDaySelector();
            renderRoutineList();
        };

        window.changeFlexComplete = function(id, amount) {
            const routine = flexRoutines.find(r => r.id === id);
            if (routine) {
                routine.completed += amount;
                if (routine.completed < 0) routine.completed = 0;
                if (routine.completed > routine.target) routine.completed = routine.target;
                saveData();
                renderFlexRoutineList();
            }
        }

        window.deleteFlexRoutine = function(id) {
            flexRoutines = flexRoutines.filter(r => r.id !== id);
            saveData();
            renderFlexRoutineList();
        }

        const modal = document.getElementById('custom-modal');

        document.getElementById('reset-week-btn').addEventListener('click', function() {
            modal.classList.remove('hidden');
        });

        document.getElementById('modal-cancel-btn').addEventListener('click', function() {
            modal.classList.add('hidden');
        });

        document.getElementById('modal-confirm-btn').addEventListener('click', function() {
            days.forEach(day => {
                if (routines[day]) {
                    routines[day].forEach(r => r.completed = false);
                }
            });
            flexRoutines.forEach(r => r.completed = 0); 
            
            hasCelebrated = false;
            saveData();
            renderDaySelector();
            renderRoutineList();
            renderFlexRoutineList();
            modal.classList.add('hidden');
        });

        function updateVisualization() {
            let totalTasks = 0;
            let totalCompleted = 0;

            days.forEach(day => {
                const dayData = routines[day] || [];
                totalTasks += dayData.length;
                totalCompleted += dayData.filter(r => r.completed).length;
            });
            
            flexRoutines.forEach(r => {
                totalTasks += r.target;
                totalCompleted += r.completed;
            });

            const percentage = totalTasks === 0 ? 0 : Math.round((totalCompleted / totalTasks) * 100);
            
            document.getElementById('weekly-percentage').textContent = `${percentage}%`;
            document.getElementById('weekly-fraction').textContent = `${totalCompleted} / ${totalTasks}`;

            const circle = document.getElementById('progress-circle');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = offset;

            const msgEl = document.getElementById('weekly-message');
            if (totalTasks === 0) {
                msgEl.innerHTML = "ë£¨í‹´ì„ ì¶”ê°€í•˜ê³  ì‹œì‘í•´ë³´ì„¸ìš”! ğŸŒ±";
                hasCelebrated = false;
            } else if (percentage === 0) {
                msgEl.innerHTML = "ì‹œì‘ì´ ë°˜ì´ì—ìš”! ì²« ì™„ë£Œë¥¼ ì‘ì›í•´ìš” âœ¨";
                hasCelebrated = false;
            } else if (percentage < 30) {
                msgEl.innerHTML = "ì¡°ê¸ˆì”© ì±„ì›Œì§€ëŠ” ê²Œ ì˜ˆë»ìš”. í™”ì´íŒ…! ğŸŒ·";
                hasCelebrated = false;
            } else if (percentage < 70) {
                msgEl.innerHTML = "ìš°ì™€, ê¾¸ì¤€íˆ ì˜í•˜ê³  ê³„ì‹œë„¤ìš”! ë©‹ì ¸ìš” ğŸ‘";
                hasCelebrated = false;
            } else if (percentage < 100) {
                msgEl.innerHTML = "ê±°ì˜ ë‹¤ ì™”ì–´ìš”! ì´ë²ˆ ì£¼ë„ í›Œë¥­í•´ìš” ğŸŒŸ";
                hasCelebrated = false;
            } else {
                msgEl.innerHTML = "ì™„ë²½í•´ìš”! ì´ë²ˆ ì£¼ ëª©í‘œë¥¼ ëª¨ë‘ ë‹¬ì„±í–ˆì–´ìš” ğŸ‘‘";
                
                if (!hasCelebrated && typeof confetti === 'function') {
                    confetti({
                        particleCount: 150,
                        spread: 80,
                        origin: { y: 0.6 },
                        colors: ['#42a272', '#9ad8b5', '#ffd700', '#ff6b6b']
                    });
                    hasCelebrated = true;
                }
            }
            
            const hour = new Date().getHours();
            const greetEl = document.getElementById('greeting-msg');
            if (hour >= 5 && hour < 12) greetEl.textContent = "ìƒì¾Œí•œ ì•„ì¹¨ì´ì—ìš”. ì˜¤ëŠ˜ë„ í™œê¸°ì°¨ê²Œ ì‹œì‘í•´ë´ìš”! â˜€ï¸";
            else if (hour >= 12 && hour < 18) greetEl.textContent = "ë‚˜ë¥¸í•œ ì˜¤í›„, ë”°ëœ»í•œ ì°¨ í•œ ì”ê³¼ í•¨ê»˜ ë£¨í‹´ì„ ì²´í¬í•´ë³¼ê¹Œìš”? â˜•";
            else greetEl.textContent = "ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³  ë§ìœ¼ì…¨ì–´ìš”. í¸ì•ˆí•œ ì €ë… ë³´ë‚´ì„¸ìš”! ğŸŒ™";
        }

        initAuth();
        
    </script>
</body>
</html>