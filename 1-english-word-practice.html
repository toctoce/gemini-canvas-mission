<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ì–´ ì—°ìŠµ í”„ë¡œê·¸ë¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-large {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        /* 3D Flip ì• ë‹ˆë©”ì´ì…˜ìš© í´ë˜ìŠ¤ */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ì”ë””ë°­ìš©) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* ë‹¨ì¶•í‚¤ í‚¤ë³´ë“œ ìŠ¤íƒ€ì¼ */
        kbd {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 1px 6px;
            font-size: 0.75rem;
            font-family: inherit;
            color: #475569;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col items-center py-10 px-4 relative">

    <!-- Initial Loader -->
    <div id="initial-loader" class="fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader-large mb-4"></div>
        <p class="text-slate-500 font-medium text-sm">í´ë¼ìš°ë“œ ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
    </div>

    <!-- Header / Stats -->
    <header class="w-full max-w-2xl mb-2 flex justify-between items-end fade-in">
        <div>
            <h1 class="text-3xl font-bold text-indigo-600 tracking-tight">ë‹¨ì–´ ì—°ìŠµ í”„ë¡œê·¸ë¨</h1>
            <p class="text-slate-500 mt-1">Oxford 3000 í•„ìˆ˜ ì˜ë‹¨ì–´ ë§ˆìŠ¤í„°í•˜ê¸°</p>
        </div>
        <div class="flex gap-4 text-center items-center">
            <!-- Streak & Heatmap Toggle -->
            <div onclick="toggleHeatmap()" class="cursor-pointer bg-emerald-50 p-3 rounded-xl shadow-sm border border-emerald-100 hover:bg-emerald-100 transition min-w-[70px]">
                <div class="text-[10px] text-emerald-500 font-semibold uppercase">Streak</div>
                <div class="text-xl font-bold text-emerald-700" id="stat-streak">0ì¼</div>
            </div>

            <!-- í´ë¦­ ì‹œ í¼ì„¼íŠ¸/ê°œìˆ˜ ì „í™˜ (Flip) -->
            <div onclick="toggleProgressFormat()" class="perspective-1000 w-[90px] h-[70px] cursor-pointer">
                <div id="progress-card" class="relative w-full h-full transition-transform duration-500 preserve-3d">
                    <!-- Front (Percent) -->
                    <div class="absolute w-full h-full backface-hidden bg-white rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center items-center">
                        <div class="text-[10px] text-slate-400 font-semibold uppercase">Progress</div>
                        <div class="text-xl font-bold text-slate-700" id="stat-progress-front">0%</div>
                    </div>
                    <!-- Back (Count) -->
                    <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-white rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center items-center">
                        <div class="text-[10px] text-slate-400 font-semibold uppercase">Learned</div>
                        <div class="text-lg font-bold text-slate-700" id="stat-progress-back">0</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Shortcut Hint -->
    <div class="w-full max-w-2xl mb-6 flex justify-start items-center gap-3 fade-in opacity-80">
        <div class="flex gap-2 text-xs text-slate-500">
            <span><kbd>W</kbd> <kbd>S</kbd> ì´ë™</span>
            <span><kbd>A</kbd> ëœ»</span>
            <span><kbd>D</kbd> ì˜ˆë¬¸ ì‘ì„±</span>
            <span><kbd>Space</kbd> í•™ìŠµ ì™„ë£Œ</span>
            <span><kbd>Enter</kbd> ì˜ˆë¬¸ ì œì¶œ</span>
        </div>
    </div>

    <!-- Heatmap (Jandi) -->
    <div id="heatmap-section" class="hidden w-full max-w-2xl mb-8 bg-white p-5 rounded-xl shadow-sm border border-slate-100 fade-in flex-col gap-2">
        <div class="text-sm font-bold text-slate-700 mb-2 flex items-center justify-between">
            <span>ë‚˜ì˜ í•™ìŠµ ì”ë””ë°­ ğŸŒ±</span>
            <span class="text-xs font-normal text-slate-400">ì‹œì‘ì¼ë¡œë¶€í„° ì „ì²´ ê¸°ë¡</span>
        </div>
        <div id="heatmap-container" class="w-full overflow-x-auto pb-2 no-scrollbar">
            <!-- ì”ë””ë°­ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- App Container -->
    <main id="app-container" class="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-lg border border-slate-100 min-h-[500px] relative">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">ì˜¤ëŠ˜ì˜ ë‹¨ì–´</h2>
        <div id="word-list" class="space-y-4">
            <!-- ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ê°€ ë Œë”ë§ë©ë‹ˆë‹¤ -->
        </div>
    </main>

    <!-- Custom Modal for Notifications -->
    <div id="toast-modal" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        <span id="toast-message">ë©”ì‹œì§€</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. ë°ì´í„° ë° ì´ˆê¸° ì„¤ì • ---
        const apiKey = ""; // ì‹¤í–‰ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.
        
        // Oxford 3000 ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ ì´ˆì••ì¶• í•˜ë“œì½”ë”© (í† í° í•œê³„ ê·¹ë³µ)
        // ë§¤ì¼ 5ê°œì”© ë½‘ì€ ë’¤, Gemini AIê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í’ˆì‚¬ì™€ ëœ»ì„ ë²ˆì—­í•´ì¤ë‹ˆë‹¤.
        const oxford3000Words = "a abandon abandoned ability able about above abroad absence absent absolute absolutely absorb abuse academic accent accept acceptable access accident accidental accidentally accommodation accompany according_to account account_for accurate accurately accuse achieve achievement acid acknowledge a_couple acquire across act action active actively activity actor actress actual actually ad adapt add addition additional address adequate adequately adjust admiration admire admit adopt adult advance advanced advantage adventure advert advertise advertisement advertising advice advise affair affect affection afford afraid after afternoon afterwards again against age aged agency agent aggressive ago agree agreement ahead aid aim air aircraft airport alarm alarmed alarming alcohol alcoholic alive all allow allowance ally almost alone along alongside aloud alphabet alphabetical already also alter alternative alternatively although altogether always amaze amazed amazing ambition ambulance among amount amuse amused amusing analyse analysis ancient and anger angle angry animal ankle anniversary announce annoy annoyed annoying annual annually another answer anticipate anxiety anxious anxiously any anyone anything anyway anywhere apart apartment apologize apparent apparently appeal appear appearance apple application apply appoint appointment appreciate approach appropriate approval approve approximate approximately april area argue argument arise arm armed arms army around arrange arrangement arrest arrival arrive arrow art article artificial artificially artist artistic as ashamed aside ask asleep aspect assist assistance assistant associate associated association assume assure at atmosphere atom attach attached attack attempt attempted attend attention attitude attorney attract attraction attractive audience august aunt author authority automatic automatically autumn available average avoid awake award aware away awful awfully awkward awkwardly baby back background backward bacteria bad badly bag baggage bake balance ball ban band bandage bank bar barely bargain barrier base baseball basic basically basis basketball bath bathroom battery battle be beach beak bear beard beat beautiful beautifully beauty because become bed bedroom beef beer before begin beginning behalf behave behavior behind belief believe bell belong below belt bend beneath benefit bent beside best bet better between beyond bicycle bid big bike bill billion bin biology bird birth bit bite bitter bitterly black blade blame blank blind block blonde blood blow blue board boat body boil bomb bone book boot border bore bored boring born borrow boss both bother bottle bottom bound bowl box boy boyfriend brain branch brand brave bread break breakfast breast breath breathe breathing breed brick bridge brief briefly bright brightly brilliant bring broad broadcast broadly broken brother brown brush bubble budget build building bullet bunch burn burst bury bus bush business businessman busy but butter button buy buyer by cabinet cable cake calculate calculation call called calm calmly camera camp campaign camping can cancel cancer candidate candy cap capable capacity capital captain capture car card care career careful carefully careless carelessly carpet carrot carry case cash cast castle cat catch category cause cd cease ceiling celebrate celebration cell cellphone cent centre century ceremony certain certainly certificate chain chair chairman challenge chamber champion championship chance change channel chapter character characteristic charge charity chart chase chat cheap cheaply cheat check cheek cheer cheerful cheerfully cheese chemical chemist chemistry cheque chest chew chicken chief chiefly child childhood chip chocolate choice choose chop church cigarette cinema circle circumstance citizen city civil claim class classic classical clean clear clearly clerk clever click client climate climb climbing clock close closed closely closet cloth clothes clothing cloud club clue coach coal coast coat code coffee coin cold coldly collapse colleague collect collection college color column combination combine come comedy comfort comfortable comfortably command comment commercial commission commit commitment committee common commonly communicate communication community company compare comparison compete competition competitive complain complaint complete completely complex complicate complicated computer concentrate concentration concept concern concerned concerning concert conclude conclusion concrete condition conduct conference confidence confident confidently confirm conflict confront confuse confused confusing confusion congratulate congratulation congress connect connection conscious consequence conservative consider considerable considerably consideration consist constant constantly construct construction consult consumer contact contain container contemporary content contest context continent continue continuous continuously contract contrast contribute contribution control convenient convention conventional conversation convert convince cooking cool cope copy core corner correct correctly cost cottage cotton cough could council count country county couple courage course court cousin cover covered covering cow crack craft crash crazy cream create creature credit crew crime criminal crisis crisp criterion critical criticism criticize crop cross crowd crowded crown crucial cruel crush cry cultural culture cup cupboard cure curious curiously curl curly current currently curtain curve curved custom customer customs cut cycle dad daily damage damp dance dancer dancing danger dangerous dare dark data date daughter day dead deaf deal dear death debate debt decade decay december decide decision declare decline decorate decoration decorative decrease deep deeply defeat defence defend define definite definitely definition degree delay deliberate deliberately delicate delicious delight delighted deliver delivery demand demonstrate dentist deny department departure depend deposit depress depressed depressing depth derive describe description desert deserve design designer desk desperate desperately despite destroy destruction detail detailed determination determine determined develop development device devote devoted diagram diamond diary dictionary die diet difference different differently difficult difficulty dig dinner direct direction directly director dirt dirty disabled disagree disappear disappoint disappointed disappointing disappointment disaster disc discipline discount discover discovery discuss discussion disease disgust disgusted disgusting dish dismiss display dissolve distance distinguish distribute distribution district divide division divorce divorced do doctor document dog dollar domestic dominate door dot double doubt down downstairs downward downwards draft drag draw drawer drawing dream dress drink drive driver drop drug drum drunk dry due dull dump during dust duty dvd each ear early earn earth ease easily east eastern easy eat economic economy edge edit edition editor educate educated education educational effect effective effectively efficiency efficient effort egg either elbow elderly elect election electric electrical electricity electronic elegant element elephant elevator else elsewhere email embarrass embarrassed embarrassing emerge emergency emotion emotional emphasis emphasize empire employ employee employer employment empty enable encounter encourage end enemy energy engage engine engineer engineering enjoy enjoyable enormous enough ensure enter entertain entertainment enthusiasm enthusiastic entire entirely entitle entrance entry envelope environment environmental equal equally equipment error escape especially essay essential essentially establish estate estimate etc european evaluate even evening event eventually ever every everyone everything everywhere evidence evil exact exactly exaggerate exaggerated exam examination example excellent except exception exchange excite excited excitement exciting exclude excluding excuse executive exercise exhibit exhibition exist existence existing exit expand expect expectation expected expense expensive experience experienced experiment expert explain explanation explode explore explosion export expose express expression extend extension extensive extent extra extraordinary extreme extremely eye face facility fact factor factory fail failure fair fairly faith fall false familiar family famous fan fancy far farm farmer farming farther farthest fashion fashionable fast fasten fat father faucet fault favor favorite fear feather feature february federal fee feed feel feeling fellow female fence festival fetch fever few field fierce fiercely fifteen fifth fifty fight fighting figure file fill film final finally finance financial find fine finely finger finish fire firm firmly first fish fishing fit fix fixed flag flame flash flat flavor flesh flight float flood floor flour flow flower flu fly flying focus fold folding follow following food foot football for force forecast foreign forest forever forget forgive fork form formal formally format former formerly formula forty forward found foundation frame free freedom freely freeze frequent frequently fresh freshly friday friend friendly friendship frighten frightened frightening from front frozen fruit fry fuel full fully fun function fund fundamental funeral funny fur furniture further future gain gallon gamble gambling game gap garage garbage garden gas gasoline gate gather general generally generate generation generous gently gentleman genuine geography get giant gift girl girlfriend give glad glass global glove go goal god gold good goodbye goods govern government governor grab grade gradually grain grammar grand grandchild granddaughter grandmother grandparent grandson grant grass grateful grave gray great greatly green grocery ground group grow growth guarantee guard guess guest guide guilty gun guy habit hair half hall hammer hand handle hang happen happily happy hard hardly harm harmful harmless hat hate hatred have he head headache heal health healthy hear hearing heart heat heater heaven heavily heavy heel height helicopter hell hello help helpful her here hero hers herself hesitate hi hide high highlight highly highway hill him himself hip hire his historical history hit hold hole holiday hollow holy home homework honest honestly honor hook hope horizontal horn horror horse hospital host hot hotel hour house household housing how however huge human humorous hungry hunt hunting hurry hurt husband i ice idea ideal identify identity if ill illegal illness illustrate image imaginary imagine immediate immediately import importance important importantly impose impossible impress impressed impression impressive improve improvement in inch incident include including income increase increasingly indeed independent index indicate indirect individual indoor indoors industrial industry infection influence inform initial initially initiative injure injured injury ink inner innocent insect insert inside insist instance instead institute institution instruction instrument insult insurance intelligence intelligent intend intention interest interested interesting internal international internet interpret interrupt interview into introduce introduction invent invention invest investigate investigation investment invitation invite involve iron island issue it item its itself jacket jail january jaw jazz jealous jeans job join joint joke journalist journey joy judge judgment juice jump junior just justice justify keep key keyboard kick kid kill kilometer kind kindly king kiss kitchen knee knife knit knock knot know knowledge label laboratory labor lack lady lake lamp land landscape language large largely last late lately later latest latter laugh launch law lawyer lay lazy lead leader leadership leading leaf league lean learn least leather leave left leg legal legally lemon lend length less lesson let letter level library license lid lie life lift light lightly like likely limit line link lip liquid list listen literature little live lively load loan local locally locate location lock logic logical lonely long look loose loosely lord lorry lose loss lost lot loud loudly love lovely lover low loyal luck lucky lump lunch lung machine machinery mad magazine magic mail main mainly maintain major majority make male mall man manage management manager manner many map march mark market marketing marriage married marry mass massive master match matching material mathematics matter maximum may maybe mayor me meal mean meaning means meanwhile measure measurement meat media medical medicine medium meet meeting member membership memory mental mention menu mere merely mess message metal method middle midnight might mild mile military milk mind mine mineral minimum minister ministry minor minority minute mirror miss missing mistake mix mixed model modern mom moment monday money monkey month mood moon moral more moreover morning most mostly mother motion motor mountain mouse mouth move movement movie much mud multiply murder muscle museum music musical musician must my myself mysterious mystery nail naked name narrow nasty nation national natural naturally nature navy near nearby nearly neat necessarily necessary neck need needle negative neighbor neighborhood neither nephew nerve nervous nest net network never nevertheless new newly news newspaper next nice nicely niece night no nobody nod noise noisy non none nonsense nor normal normally north northern nose not note nothing notice noticeable novel november now nowhere nuclear number nurse nut object objective observation observe obtain obvious obviously occasion occasionally occupation occupy occur ocean'clock october odd oddly of off offence offend offense offensive offer office officer official officially often oh oil old old-fashioned on once one onion only onto open opening openly operate operation opinion opponent opportunity oppose opposite opposition option or orange order ordinary organ organization organize origin original originally other otherwise ought ounce our ours ourselves out outdoor outdoors outer outline outside outstanding oven over overall overcome owe own owner pace pack package packaging packet page pain painful paint painter painting pair palace pale pan panel pants paper parent park parking parliament part partial partially participate particular particularly partly partner partnership party pass passage passenger passing passport past path patience patient pattern pause pay payment peace peaceful peak pen penalty pencil penny people pepper per percentage perfect perfectly perform performance performer perhaps period permanent permanently permission permit person personal personality personally personnel perspective persuade pet phase philosophy phone photo photograph photographer photography phrase physical physically physics piano pick picture piece pig pile pill pilot pin pink pipe pitch pity place plain plan plane planet plant plastic plate platform play player pleasant please pleased pleasing pleasure plenty plot plug plus pocket poem poetry point pointed poison poisonous pole police policy polish polite political politically politician politics pollution pool poor pop popular population port pose position positive possess possession possibility possible possibly post pot potato potential potentially pound pour poverty powder power powerful practical practically practice praise pray prayer precisely predict prefer preference pregnant premises preparation prepare prepared presence present presentation preserve president press pressure presumably pretend pretty prevent previous previously price pride priest primarily primary prime prince princess principal principle print printer prior priority prison prisoner private privately prize probable probably problem procedure proceed process produce producer product production profession professional professor profit program project promise promote promotion prompt promptly pronounce pronunciation proof proper properly property proportion proposal propose prospect protect protection protest proud proudly prove provide provided pub public publication publicly publish publisher pudding pull punch punish punishment pupil purchase pure purely purple purpose pursue push put qualification qualify quality quantity quarter queen question quick quickly quiet quietly quit quite quote race racing radio rail railroad railway rain raise range rank rapid rapidly rare rarely rate rather raw reach react reaction read reader reading ready real realistic reality realize really reason reasonable reasonably recall receipt receive recent recently reception reckon recognition recognize recommend record recording recover red reduce reduction refer reference reflect reform refrigerator refusal refuse regard regarding region regional register regret regular regularly relate relation relationship relative relatively relax relaxed relaxing release relevance relief religion religious rely remain remark remarkable remember remind remote removal remove rent repair repeat repeatedly replace reply report reporter represent representative reproduce reputation request require requirement rescue research researcher reservation reserve respect respond response responsibility responsible rest restaurant restore restrict restriction result retain retire retired retirement return reveal reverse review revise revision revolution reward rhythm rice rich rid ride rider ridiculous riding right rightly ring rise risk rival river road rob rock role roll romantic roof room root rope rough roughly round route routine row royal rub rubber rubbish rude ruin rule run runner running rural rush sack sad sadly sadness safe safely safety sail sailing sailor salad salary sale salt same sample sand satisfaction satisfy satisfying saturday sauce save saving say scale scan scare scared scary scene schedule scheme school science scientific scientist scissors score scratch scream screen screw script sea seal search season seat second secondary secret secretary section sector secure security see seed seek seem select selection self sell seller send senior sense sensible sensitive sentence separate separated separately separation september series serious seriously servant serve service session set settle settlement several severe severely sew sex sexual sexually shade shadow shake shall shallow shame shape share sharp sharply shave she sheep sheet shelf shell shelter shift shine shiny ship shirt shock shocked shocking shoe shoot shooting shop shopping short shortly shot should shoulder shout show shower shut shy sick side sight sign signal signature significance significant significantly silence silent silk silly silver similar similarly simple simply sin since sincere sincerely sing singer singing single sink sir sister sit site situation six size skill skilled skin skirt sky sleep sleeve slice slide slight slightly slip slope slow slowly smash smell smile smoke smoking smooth smoothly snake snow so soap social socially society sock soft softly software soil soldier solid solution solve some somebody somehow someone something sometimes somewhat somewhere son song soon sore sorry sort soul sound soup sour source south southern space speak speaker special specialist specially specific specifically speech speed spell spelling spend spice spicy spider spin spirit spiritual split spoil spoken spoon sport spot spray spread spring square squeeze stable staff stage stair stamp stand standard star stare start state statement station statue status stay steadily steady steal steam steel steep steer step stick sticky stiff still sting stir stock stomach stone stop store storm story stove straight strain strange strangely stranger strategy stream street strength stress stretch strict strictly strike striking string strip stripe strong strongly structure struggle student studio study stuff stupid style subject substance substantial substantially substitute succeed success successful successfully such suck sudden suddenly suffer suffering sugar suggest suggestion suit suitable suitcase sum summer sun sunday supermarket supply support supporter suppose sure surely surface surgery surprise surprised surprising surprisingly surround surrounding surroundings survey survive suspect suspicion suspicious swallow swear sweat sweater sweep sweet swell swimming swing switch symbol sympathetic sympathy symptom system table tablet tackle tail take talk tall tank tap tape target task taste tax taxi tea teach teacher teaching team tear technical technique technology telephone television tell temper temperature temporary tend tendency tension tent term terrible terribly test text than thank thanks that the theater their theirs them theme themselves then theory there therefore these they thick thickly thief thin thing think thinking thirsty thirteen thirty this thoroughly those though thought thread threat threaten three throat through throughout throw thumb thursday thus ticket tie tight tightly till time tin tiny tip tire tired title to today toe together toilet tomato tomorrow ton tone tongue tonight too tool tooth top topic total totally touch tough tour tourist toward towards towel tower town toy trace track trade tradition traditional traffic train training transfer transform translate translation transparent transport transportation trap travel traveler treat treatment tree trend trial trick trip trouble trousers truck true truly trust truth try tube tuesday tune tunnel turn twelve twenty twice twin twist two type typical typically ugly ultimate ultimately unable uncle under underground underneath understand understanding underwear undo unemployed unemployment unexpected unfair unfortunately unhappy uniform union unique unit unite united universe university unknown unless unlike unlikely unload unlucky unnecessary until unusual unusually up upon upper upset upside upstairs upward upwards urban urge urgent us use used useful useless user usual usually vacation valid valley valuable value van variation variety various vary vast vegetable vehicle version very via victim victory video view village violence violent virtually virus visible vision visit visitor visual vital voice volume vote wage waist wait waiter wake walk wall wander want war warm warn wash waste watch water wave way we weak weakness weakly wealth weapon wear weather weave web website wedding wednesday week weekend weekly weigh weight weird welcome well west western wet what whatever wheel when whenever where whereas wherever whether which while whisper white who whole whom whose why wide widely width wife wild will willing willingly win wind window wine wing winner winter wipe wire wisdom wise wish with withdraw within without witness woman wonder wonderful wood wooden wool word work worker world worried worry worse worst worth would wound wrap wrist write writer writing wrong yard yawn yeah year yellow yes yesterday yet you young your yours yourself youth zero zone"
         .replace(/_/g, " ")
         .split(" ");

        let appState = {
            lastAccessDate: null, 
            dailyWords: [],
            seenWords: [],
            totalLearned: 0,
            history: {}
        };

        let progressFormat = 'percent'; // 'percent' ë˜ëŠ” 'count'
        let focusedWordIndex = 0; // ë‹¨ì¶•í‚¤ í¬ì»¤ìŠ¤ë¥¼ ìœ„í•œ ìƒíƒœ
        let isTranslating = false; // ë²ˆì—­ ì¤‘ ìƒíƒœ í”Œë˜ê·¸

        // --- Firebase ì—°ë™ ë¡œì§ ---
        let currentUser = null;
        let db = null;
        let appId = 'default-app-id';
        let isFirstLoad = true;
        let cloudUnsubscribe = null;

        async function initFirebase() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    db = getFirestore(app);

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            listenToCloudState(); // getDoc ëŒ€ì‹  ì‹¤ì‹œê°„ ê°ì§€ í•¨ìˆ˜ ì‹¤í–‰
                        }
                    });
                } else {
                    loadLocalState();
                    startApp();
                }
            } catch (err) {
                console.error("Firebase Init Error:", err);
                loadLocalState();
                startApp();
            }
        }

        // í´ë¼ìš°ë“œ ì‹¤ì‹œê°„ ê°ì§€ ë° ë™ê¸°í™”
        function listenToCloudState() {
            if (!db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sharedApp', 'globalState');
            
            if (cloudUnsubscribe) cloudUnsubscribe();
            
            // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì´ í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì¦‰ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤.
            cloudUnsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    
                    // ë™ê¸°í™” ì‹œ, í˜„ì¬ ì‚¬ìš©ìê°€ íƒ€ì´í•‘ ì¤‘ì¸ í…ìŠ¤íŠ¸ê°€ ë‚ ì•„ê°€ì§€ ì•Šë„ë¡ ë³´í˜¸
                    if (!isFirstLoad && appState.dailyWords && cloudData.dailyWords) {
                        appState.dailyWords.forEach((item, idx) => {
                            const s0 = document.getElementById(`s-${idx}-0`);
                            const s1 = document.getElementById(`s-${idx}-1`);
                            const s2 = document.getElementById(`s-${idx}-2`);
                            if (cloudData.dailyWords[idx]) {
                                if (s0 && document.activeElement === s0) cloudData.dailyWords[idx].sentences[0] = s0.value;
                                if (s1 && document.activeElement === s1) cloudData.dailyWords[idx].sentences[1] = s1.value;
                                if (s2 && document.activeElement === s2) cloudData.dailyWords[idx].sentences[2] = s2.value;
                            }
                        });
                    }

                    appState = cloudData;
                    if (!appState.history) appState.history = {};
                    localStorage.setItem('oxford3000_state_v2', JSON.stringify(appState));
                    
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        startApp();
                    } else {
                        // ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë³€ê²½ì‚¬í•­ì´ ë°œìƒí•˜ë©´ í™”ë©´ì„ ì¦‰ì‹œ ê°±ì‹ 
                        updateHeaderStats();
                        renderDashboard();
                    }
                } else {
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        loadLocalState();
                        startApp();
                    }
                }
            }, (error) => {
                console.error("Cloud sync error:", error);
                if (isFirstLoad) {
                    isFirstLoad = false;
                    loadLocalState();
                    startApp();
                }
            });
        }

        async function saveStateToCloud() {
            if (!currentUser || !db) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sharedApp', 'globalState');
                await setDoc(docRef, appState);
            } catch(e) {
                console.error("Cloud save error:", e);
            }
        }

        // --- 2. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë° ì´ˆê¸° ë¡œì§ ---
        function getTodayString() {
            const now = new Date();
            // ìƒˆë²½ 5ì‹œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë£¨ê°€ ë„˜ì–´ê°€ë„ë¡ ì„¤ì • (5ì‹œê°„ ë¹¼ê¸°)
            now.setHours(now.getHours() - 5);
            return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
        }
        
        // ë‚ ì§œ ê¸°ë°˜ ì‹œë“œ ìƒì„± í•¨ìˆ˜ (ë™ì¼í•œ ë‚ ì§œì—ëŠ” í•­ìƒ ë™ì¼í•œ ìˆ«ì ìƒì„±)
        function getSeedFromDate(dateStr) {
            let hash = 0;
            for (let i = 0; i < dateStr.length; i++) {
                hash = Math.imul(31, hash) + dateStr.charCodeAt(i) | 0;
            }
            return hash;
        }

        // ê²°ì •ë¡ ì  ë‚œìˆ˜ ìƒì„±ê¸° (PRNG) - Seed ê¸°ë°˜ìœ¼ë¡œ ì„ê¸° ìœ„í•¨
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        function loadLocalState() {
            const saved = localStorage.getItem('oxford3000_state_v2');
            if (saved) {
                appState = JSON.parse(saved);
                if (!appState.history) appState.history = {};
            }
        }

        function saveState() {
            localStorage.setItem('oxford3000_state_v2', JSON.stringify(appState));
            updateHeaderStats();
            
            if (currentUser && db) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'sharedApp', 'globalState');
                setDoc(docRef, appState).catch(e => console.error("Cloud save error:", e));
            }
        }

        function selectDailyWords() {
            const today = getTodayString();
            
            // ì˜¤ëŠ˜ ì´ë¯¸ ë‹¨ì–´ë¥¼ ë°°ì •ë°›ì•˜ë‹¤ë©´ ìŠ¤í‚µ
            if (appState.lastAccessDate === today && appState.dailyWords.length === 5) {
                return;
            }

            // ì•ˆ ë³¸ ë‹¨ì–´ë“¤ë§Œ í•„í„°ë§ (ì™„ë£Œí•˜ì§€ ì•Šì€ ë‹¨ì–´ëŠ” seenWordsì— ì—†ìœ¼ë¯€ë¡œ ë‹¤ì‹œ í’€ì— ë“¤ì–´ê°)
            let availableWords = oxford3000Words.filter(w => !appState.seenWords.includes(w));
            
            // ëª¨ë“  ë‹¨ì–´ë¥¼ ë‹¤ ë´¤ë‹¤ë©´ ì´ˆê¸°í™”
            if (availableWords.length < 5) {
                showToast("3000 ë‹¨ì–´ë¥¼ ëª¨ë‘ í•™ìŠµí–ˆìŠµë‹ˆë‹¤! ë³µìŠµ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.");
                appState.seenWords = [];
                availableWords = [...oxford3000Words];
            }

            // ê¸°ê¸°ë§ˆë‹¤ ë°°ì—´ ìˆœì„œê°€ ë‹¤ë¥¼ ìˆ˜ ìˆëŠ” ì ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì•ŒíŒŒë²³ìˆœ ì •ë ¬
            availableWords.sort();

            // ë‚ ì§œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚œìˆ˜ ìƒì„±ê¸° ì´ˆê¸°í™” (ì–´ë–¤ ê¸°ê¸°ë“  ë™ì¼í•œ ë‚ ì§œë©´ ë™ì¼í•œ 5ë‹¨ì–´ ì¶”ì¶œ)
            const seed = getSeedFromDate(today);
            const random = mulberry32(seed);

            // ì˜¤ëŠ˜ ë°°ì •ë  5ê°œ ì˜ë‹¨ì–´ ì¶”ì¶œ
            const selectedStrings = [];
            for (let i = 0; i < 5; i++) {
                if (availableWords.length === 0) break;
                // random()ì€ í•­ìƒ ì¼ì •í•œ ìˆœì„œì˜ ë‚œìˆ˜ë¥¼ ë°˜í™˜
                const index = Math.floor(random() * availableWords.length);
                selectedStrings.push(availableWords[index]);
                availableWords.splice(index, 1); // ë½‘ì€ ë‹¨ì–´ëŠ” ì œì™¸
            }
            
            // ì„ì‹œë¡œ ì˜ì–´ ë‹¨ì–´ë§Œ ë„£ê³  í™”ë©´ì„ ê·¸ë¦¼
            appState.dailyWords = selectedStrings.map(w => ({
                word: w,
                pos: "...",
                meaning: "AIê°€ ëœ»ì„ ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤...",
                completed: false,
                sentences: ["", "", ""]
            }));
            appState.lastAccessDate = today;
            
            if (appState.history[today] === undefined) {
                appState.history[today] = 0;
            }
            
            saveState();
            renderDashboard();

            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ Geminië¥¼ í†µí•´ ëœ»ê³¼ í’ˆì‚¬ ê°€ì ¸ì˜¤ê¸°
            fetchMeaningsFromGemini(selectedStrings);
        }

        // ì‹¤ì‹œê°„ìœ¼ë¡œ 5ë‹¨ì–´ì˜ ëœ»ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchMeaningsFromGemini(wordsArray) {
            if (isTranslating) return;
            isTranslating = true;
            
            const prompt = `
ë‹¤ìŒ 5ê°œì˜ ì˜ì–´ ë‹¨ì–´ì— ëŒ€í•œ í’ˆì‚¬(ì˜ì–´ ì•½ì–´, ì˜ˆ: v., n., adj.)ì™€ í•œêµ­ì–´ ëœ»ì„ ì œê³µí•´ì£¼ì„¸ìš”.
ë‹¨ì–´ ëª©ë¡: ${wordsArray.join(', ')}

ë°˜ë“œì‹œ ì•„ë˜ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(\`\`\`json ë“±)ë‚˜ ë‹¤ë¥¸ ì„¤ëª…ì€ ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.
[
  {"word": "ë‹¨ì–´1", "pos": "í’ˆì‚¬", "meaning": "í•œêµ­ì–´ ëœ»"},
  {"word": "ë‹¨ì–´2", "pos": "í’ˆì‚¬", "meaning": "í•œêµ­ì–´ ëœ»"}
]
`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const result = await fetchWithBackoff(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const textResp = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
                const cleanJson = textResp.replace(/```json/g, '').replace(/```/g, '').trim();
                const translatedData = JSON.parse(cleanJson);

                // ë²ˆì—­ëœ ë°ì´í„° ë§¤í•‘
                appState.dailyWords = appState.dailyWords.map(item => {
                    const trans = translatedData.find(t => t.word.toLowerCase() === item.word.toLowerCase());
                    if (trans) {
                        return { ...item, pos: trans.pos, meaning: trans.meaning };
                    }
                    return item;
                });
                saveState();
                renderDashboard();
                showToast("ì˜¤ëŠ˜ì˜ ë‹¨ì–´ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch (error) {
                console.error("Meaning Fetch Error:", error);
                // ì‹¤íŒ¨ ì‹œ í´ë°±
                appState.dailyWords = appState.dailyWords.map(item => ({
                    ...item,
                    pos: "ì•Œ ìˆ˜ ì—†ìŒ",
                    meaning: "(ì‚¬ì „ì„ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”)"
                }));
                saveState();
                renderDashboard();
                showToast("ëœ»ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                isTranslating = false;
            }
        }

        function toggleProgressFormat() {
            progressFormat = progressFormat === 'percent' ? 'count' : 'percent';
            const card = document.getElementById('progress-card');
            if (progressFormat === 'count') {
                card.classList.add('rotate-y-180');
            } else {
                card.classList.remove('rotate-y-180');
            }
        }

        function updateHeaderStats() {
            const totalWords = 3000; // ì „ì²´ ë‹¨ì–´ ìˆ˜ ê¸°ì¤€ì  (ì‹¤ì œë¡œëŠ” 3000ê°œê°€ ì•„ë‹ˆë”ë¼ë„ ê¸°ì¤€ì ì€ ìœ ì§€)
            const current = appState.totalLearned;
            
            const pct = ((current / totalWords) * 100).toFixed(1);
            document.getElementById('stat-progress-front').innerText = `${pct}%`;
            document.getElementById('stat-progress-back').innerText = `${current}`;

            // ìŠ¤íŠ¸ë¦­(ì—°ì† í•™ìŠµì¼) ê³„ì‚° ë¡œì§
            let streak = 0;
            let checkDate = new Date();
            let todayStr = `${checkDate.getFullYear()}-${checkDate.getMonth() + 1}-${checkDate.getDate()}`;
            
            // ì˜¤ëŠ˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìœ¼ë©´, í™•ì¸ ì‹œì‘ì¼ì„ ì–´ì œë¡œ ì„¤ì •
            if (!appState.history[todayStr] || appState.history[todayStr] === 0) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // ê³¼ê±°ë¡œ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ë©° ì—°ì†ì¼ ê³„ì‚°
            while (true) {
                let str = `${checkDate.getFullYear()}-${checkDate.getMonth() + 1}-${checkDate.getDate()}`;
                if (appState.history[str] > 0) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            document.getElementById('stat-streak').innerText = `${streak}ì¼`;

            renderHeatmap();
        }

        // --- ë‹¨ì¶•í‚¤ í¬ì»¤ìŠ¤ UI ì—…ë°ì´íŠ¸ ---
        function updateFocusUI() {
            appState.dailyWords.forEach((_, i) => {
                const card = document.getElementById(`word-card-${i}`);
                if (card) {
                    if (i === focusedWordIndex) {
                        card.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
                        // í™”ë©´ì— ì™„ì „íˆ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ ì¡°ì • (ë¶€ë“œëŸ½ê²Œ)
                        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        card.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2');
                    }
                }
            });
        }

        function setFocus(index) {
            if (focusedWordIndex !== index) {
                // ë‹¤ë¥¸ ë‹¨ì–´ë¡œ í¬ì»¤ìŠ¤ê°€ ì´ë™í•  ë•Œ ì´ì „ì— ì—´ë ¤ìˆë˜ ì°½ì„ ëª¨ë‘ ë‹«ê¸° (ìë™ ë‹«í˜)
                const prevMeaning = document.getElementById(`section-meaning-${focusedWordIndex}`);
                const prevSentences = document.getElementById(`section-sentences-${focusedWordIndex}`);
                
                if (prevMeaning && !prevMeaning.classList.contains('hidden')) {
                    prevMeaning.classList.add('hidden');
                }
                if (prevSentences && !prevSentences.classList.contains('hidden')) {
                    prevSentences.classList.add('hidden');
                }
            }
            focusedWordIndex = index;
            updateFocusUI();
        }

        // --- 3. UI ë Œë”ë§ ---
        function toggleHeatmap() {
            const section = document.getElementById('heatmap-section');
            section.classList.toggle('hidden');
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap-container');
            const historyKeys = Object.keys(appState.history);
            
            if (historyKeys.length === 0) {
                container.innerHTML = '<div class="text-sm text-slate-400">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ëª¨ë°”ì¼(Safari ë“±)ì—ì„œ "YYYY-M-D" í¬ë§· íŒŒì‹± ì˜¤ë¥˜(Invalid Date)ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì§ì ‘ ìª¼ê°œì„œ íŒŒì‹±
            const dates = historyKeys.map(d => {
                const parts = d.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]).getTime();
            });
            let startDate = new Date(Math.min(...dates));
            
            const today = new Date();
            today.setHours(today.getHours() - 5); // ìƒˆë²½ 5ì‹œ ê°±ì‹  ê¸°ì¤€ ë™ì¼í•˜ê²Œ ì ìš©

            // ì‹œì‘ì¼ì„ ì¼ìš”ì¼ë¡œ ë§ì¶¤ (ì¼=0, ì›”=1, ... í† =6)
            startDate.setDate(startDate.getDate() - startDate.getDay());

            let html = '<div class="grid grid-rows-7 grid-flow-col gap-[3px] w-max">';

            let currentDate = new Date(startDate);
            // ì˜¤ëŠ˜ì´ í¬í•¨ëœ ì£¼ì˜ í† ìš”ì¼ê¹Œì§€ ê·¸ë¦¬ë“œ ìƒì„±
            let endDate = new Date(today);
            endDate.setDate(endDate.getDate() + (6 - endDate.getDay()));

            while (currentDate <= endDate) {
                const dateStr = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-${currentDate.getDate()}`;
                const count = appState.history[dateStr] || 0;
                
                let colorClass = 'bg-slate-100'; // ê¸°ë³¸(0)
                if (currentDate > today) {
                    colorClass = 'bg-transparent'; // ë¯¸ë˜ ë‚ ì§œëŠ” íˆ¬ëª…í•˜ê²Œ
                } else if (count === 1) colorClass = 'bg-emerald-200';
                else if (count === 2 || count === 3) colorClass = 'bg-emerald-400';
                else if (count === 4) colorClass = 'bg-emerald-500';
                else if (count >= 5) colorClass = 'bg-emerald-600';

                const titleText = currentDate <= today ? `${currentDate.getFullYear()}.${currentDate.getMonth() + 1}.${currentDate.getDate()} - ${count}ê°œ ì™„ë£Œ` : '';

                html += `<div title="${titleText}" class="w-3.5 h-3.5 rounded-sm ${colorClass} ${currentDate <= today ? 'cursor-help hover:ring-2 hover:ring-slate-400' : ''}"></div>`;

                currentDate.setDate(currentDate.getDate() + 1);
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderDashboard() {
            const listContainer = document.getElementById('word-list');
            let html = '';

            appState.dailyWords.forEach((item, index) => {
                const bgClass = item.completed ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-200 hover:border-indigo-300';
                const textClass = item.completed ? 'text-slate-400 line-through' : 'text-slate-800';
                const checkClass = item.completed ? 'bg-slate-200 text-slate-400' : 'bg-indigo-100 text-indigo-600';

                // ì¹´ë“œ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ ì´ë™ ë°˜ì˜
                html += `
                    <div id="word-card-${index}" onclick="setFocus(${index})" class="p-5 rounded-xl border transition-all ${bgClass} cursor-pointer">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <!-- ë‹¨ì–´ ì •ë³´ -->
                            <div class="flex items-center gap-4">
                                <div id="word-circle-${index}" class="w-8 h-8 rounded-full ${checkClass} flex items-center justify-center font-bold text-sm flex-shrink-0 transition-colors">
                                    ${item.completed ? 'âœ“' : index + 1}
                                </div>
                                <h3 id="word-text-${index}" class="text-xl font-bold ${textClass} flex items-center gap-2 transition-colors">
                                    ${item.word}
                                    <span class="text-sm font-normal text-slate-500 italic no-underline">${item.pos}</span>
                                </h3>
                            </div>
                            
                            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                            <div class="flex flex-wrap gap-2">
                                <button onclick="event.stopPropagation(); toggleSection(${index}, 'meaning')" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 transition">ëœ»</button>
                                <button onclick="event.stopPropagation(); toggleSection(${index}, 'sentences')" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-indigo-50 hover:bg-indigo-100 text-indigo-700 transition flex items-center gap-1">
                                    ì˜ˆë¬¸ ì‘ì„±
                                </button>
                                <div id="complete-btn-wrap-${index}">
                                    ${!item.completed 
                                        ? `<button onclick="event.stopPropagation(); toggleComplete(${index})" class="px-4 py-1.5 text-sm font-bold rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition shadow-sm">í•™ìŠµ ì™„ë£Œ</button>` 
                                        : `<button onclick="event.stopPropagation(); toggleComplete(${index})" class="px-4 py-1.5 text-sm font-medium rounded-lg bg-slate-200 hover:bg-slate-300 text-slate-500 border border-slate-300 transition">ì™„ë£Œë¨</button>`}
                                </div>
                            </div>
                        </div>
                        
                        <!-- ìˆ¨ê²¨ì§„ ëœ» ì˜ì—­ -->
                        <div id="section-meaning-${index}" class="hidden mt-4 p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-800 font-medium animate-[fadeIn_0.2s_ease-out]">
                            ğŸ’¡ ${item.meaning}
                        </div>

                        <!-- ìˆ¨ê²¨ì§„ ì˜ˆë¬¸ ì‘ì„± ì˜ì—­ -->
                        <div id="section-sentences-${index}" class="hidden mt-4 p-4 bg-white border border-indigo-200 rounded-lg shadow-sm animate-[fadeIn_0.2s_ease-out]" onclick="event.stopPropagation();">
                            <p class="text-sm text-slate-500 mb-3 font-medium">ì˜ˆë¬¸ì„ ë§Œë“¤ê³  í”¼ë“œë°±ì„ ë°›ì•„ë³´ì„¸ìš”. (Enterë¥¼ ëˆŒëŸ¬ ë°”ë¡œ ê²€ì‚¬)</p>
                            <div class="space-y-3 mb-4">
                                <input type="text" id="s-${index}-0" onkeydown="handleInputKeydown(event, ${index})" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none text-sm transition" placeholder="ë¬¸ì¥ 1 ì‘ì„±..." value="${item.sentences[0] || ''}">
                                <input type="text" id="s-${index}-1" onkeydown="handleInputKeydown(event, ${index})" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none text-sm transition" placeholder="ë¬¸ì¥ 2 ì‘ì„±..." value="${item.sentences[1] || ''}">
                                <input type="text" id="s-${index}-2" onkeydown="handleInputKeydown(event, ${index})" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-md focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none text-sm transition" placeholder="ë¬¸ì¥ 3 ì‘ì„±..." value="${item.sentences[2] || ''}">
                            </div>
                            <button id="check-btn-${index}" onclick="handleCheckSentences(${index})" class="w-full py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-md text-sm font-bold transition flex justify-center items-center gap-2">
                                AI í”¼ë“œë°±
                            </button>
                            
                            <!-- í”¼ë“œë°± ê²°ê³¼ ì˜ì—­ -->
                            <div id="feedback-area-${index}" class="hidden mt-4 p-4 bg-indigo-50/50 border border-indigo-100 rounded-md text-sm text-indigo-950 whitespace-pre-wrap leading-relaxed"></div>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            updateFocusUI(); // ë Œë”ë§ í›„ í¬ì»¤ìŠ¤ UI ì ìš©
        }

        // --- 4. ì•¡ì…˜ í•¸ë“¤ëŸ¬ ---
        function toggleSection(index, type) {
            setFocus(index); // ì„¹ì…˜ì„ ì—´ ë•Œ í¬ì»¤ìŠ¤ë„ ë§ì¶¤
            const el = document.getElementById(`section-${type}-${index}`);
            const isHidden = el.classList.contains('hidden');
            
            if (isHidden) {
                el.classList.remove('hidden');
                // ì˜ˆë¬¸ì‘ì„± ì—´ ë•Œ ì²«ë²ˆì§¸ inputì— ìë™ í¬ì»¤ìŠ¤
                if (type === 'sentences') {
                    setTimeout(() => {
                        const firstInput = document.getElementById(`s-${index}-0`);
                        if (firstInput) firstInput.focus();
                    }, 50);
                }
            } else {
                el.classList.add('hidden');
            }
        }

        // ì…ë ¥ ì¤‘ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (Enterë¡œ ì œì¶œ, Escë¡œ ë¹ ì ¸ë‚˜ì˜¤ê¸°)
        function handleInputKeydown(e, index) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleCheckSentences(index);
            } else if (e.key === 'Escape') {
                e.target.blur(); // í¬ì»¤ìŠ¤ í•´ì œí•˜ì—¬ ë‹¨ì¶•í‚¤ ë‚´ë¹„ê²Œì´ì…˜ ëª¨ë“œë¡œ ë³µê·€
            }
        }

        // ë‹¨ì¶•í‚¤ ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œê¸€/ì˜ë¬¸ ìíŒ ì™„ë²½ ì§€ì›)
        document.addEventListener('keydown', (e) => {
            // í˜„ì¬ ì‚¬ìš©ìê°€ ì…ë ¥ì°½(input, textarea)ì— íƒ€ì´í•‘ ì¤‘ì´ë©´ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                return;
            }

            const key = e.key.toLowerCase();

            // ì•„ë˜ë¡œ ì´ë™ (S ë˜ëŠ” ã„´)
            if (key === 's' || key === 'ã„´') {
                e.preventDefault();
                setFocus(Math.min(focusedWordIndex + 1, appState.dailyWords.length - 1));
            } 
            // ìœ„ë¡œ ì´ë™ (W ë˜ëŠ” ã…ˆ)
            else if (key === 'w' || key === 'ã…ˆ') {
                e.preventDefault();
                setFocus(Math.max(focusedWordIndex - 1, 0));
            } 
            // ëœ» ì—´ê¸°/ë‹«ê¸° (A ë˜ëŠ” ã…)
            else if (key === 'a' || key === 'ã…') {
                e.preventDefault();
                toggleSection(focusedWordIndex, 'meaning');
            } 
            // ì˜ˆë¬¸ì‘ì„± ì—´ê¸°/ë‹«ê¸° (D ë˜ëŠ” ã…‡)
            else if (key === 'd' || key === 'ã…‡') {
                e.preventDefault();
                toggleSection(focusedWordIndex, 'sentences');
            } 
            // ì™„ë£Œ (Space)
            else if (key === ' ' || key === 'spacebar') {
                e.preventDefault();
                toggleComplete(focusedWordIndex);
            }
        });

        // ë Œë”ë§ ë˜ê¸° ì „ ì‚¬ìš©ìê°€ ì…ë ¥ ì¤‘ì´ë˜ ë¬¸ì¥ ë°ì´í„°ë¥¼ stateì— ì„ì‹œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        function saveCurrentInputs() {
            appState.dailyWords.forEach((item, idx) => {
                const s0 = document.getElementById(`s-${idx}-0`);
                const s1 = document.getElementById(`s-${idx}-1`);
                const s2 = document.getElementById(`s-${idx}-2`);
                if (s0) item.sentences[0] = s0.value;
                if (s1) item.sentences[1] = s1.value;
                if (s2) item.sentences[2] = s2.value;
            });
        }

        function toggleComplete(wordIndex) {
            setFocus(wordIndex);
            saveCurrentInputs(); // ê¸°ì¡´ ì…ë ¥ ë°ì´í„° ë‚ ì•„ê°€ì§€ ì•Šê²Œ ì„ì‹œì €ì¥
            const wordData = appState.dailyWords[wordIndex];
            const today = getTodayString();

            if (wordData.completed) {
                // ì™„ë£Œ ì·¨ì†Œ
                wordData.completed = false;
                appState.totalLearned = Math.max(0, appState.totalLearned - 1);
                appState.history[today] = Math.max(0, (appState.history[today] || 0) - 1);
                
                // ë‹¨ì–´ í•™ìŠµ íˆìŠ¤í† ë¦¬ì—ì„œ ì œê±° (ë‹¹ì¼ ì™„ë£Œí•œ ë‚´ì—­ ì·¨ì†Œ ì‹œ)
                const seenIdx = appState.seenWords.indexOf(wordData.word);
                if (seenIdx !== -1) {
                    appState.seenWords.splice(seenIdx, 1);
                }
                showToast("í•™ìŠµ ì™„ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                // í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
                wordData.completed = true;
                appState.totalLearned += 1;
                
                if (!appState.seenWords.includes(wordData.word)) {
                    appState.seenWords.push(wordData.word);
                }

                appState.history[today] = (appState.history[today] || 0) + 1;
                showToast("í•™ìŠµ ì™„ë£Œ! ì”ë””ê°€ 1í¬ê¸° ì‹¬ì–´ì¡ŒìŠµë‹ˆë‹¤ ğŸŒ±");
            }

            saveState();
            renderDashboard(); // ì „ì²´ ìƒíƒœë¥¼ ë°˜ì˜í•˜ì—¬ ì¬ë Œë”ë§
        }

        function showToast(message) {
            const toast = document.getElementById('toast-modal');
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        // Module ìŠ¤ì½”í”„ ì´ìŠˆ í•´ê²°: HTMLì—ì„œ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ë“¤ì„ windowì— í• ë‹¹
        window.toggleHeatmap = toggleHeatmap;
        window.toggleProgressFormat = toggleProgressFormat;
        window.toggleSection = toggleSection;
        window.toggleComplete = toggleComplete;
        window.handleCheckSentences = handleCheckSentences;
        window.handleInputKeydown = handleInputKeydown;
        window.setFocus = setFocus;

        // --- 5. Gemini API (ì—„ê²©í•œ í”¼ë“œë°± ë°˜ì˜) ---
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        async function handleCheckSentences(wordIndex) {
            const wordData = appState.dailyWords[wordIndex];
            const s0 = document.getElementById(`s-${wordIndex}-0`).value.trim();
            const s1 = document.getElementById(`s-${wordIndex}-1`).value.trim();
            const s2 = document.getElementById(`s-${wordIndex}-2`).value.trim();

            if (!s0 && !s1 && !s2) {
                showToast("ìµœì†Œ í•œ ë¬¸ì¥ ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                return;
            }

            const btn = document.getElementById(`check-btn-${wordIndex}`);
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<div class="loader"></div> í”¼ë“œë°± ì¤‘...`;
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            const prompt = `
ë‹¹ì‹ ì€ ì‹¤ìš©ì ì¸ ì˜ì–´ íšŒí™”ë¥¼ ë•ëŠ” ì›ì–´ë¯¼ íŠœí„°ì…ë‹ˆë‹¤.
í•™ìŠµí•  ì˜ë‹¨ì–´: '${wordData.word}' (í’ˆì‚¬: ${wordData.pos}, ëœ»: ${wordData.meaning})

ì‘ì„±ëœ ë¬¸ì¥:
ë¬¸ì¥ 1: ${s0 || "(ì‘ì„±ì•ˆí•¨)"}
ë¬¸ì¥ 2: ${s1 || "(ì‘ì„±ì•ˆí•¨)"}
ë¬¸ì¥ 3: ${s2 || "(ì‘ì„±ì•ˆí•¨)"}

ë‹¤ìŒ ì§€ì¹¨ì„ ì—„ê²©í•˜ê²Œ ì§€ì¼œì„œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:
1. í‰ê°€ì˜ í•µì‹¬ì€ 'ì œì‹œëœ ë‹¨ì–´(${wordData.word})ë¥¼ ë¬¸ë§¥ê³¼ íšŒí™” ìƒí™©ì— ì•Œë§ê²Œ ì˜ í™œìš©í–ˆëŠ”ê°€' ì…ë‹ˆë‹¤.
2. ì™„ë²½í•œ í™œìš©: ë‹¨ì–´ ì‚¬ìš©ì´ ìì—°ìŠ¤ëŸ½ë‹¤ë©´ "ì™„ë²½í•˜ê²Œ ì˜ í™œìš©í•˜ì…¨ìŠµë‹ˆë‹¤!"ë¼ê³ ë§Œ ê°„ë‹¨íˆ ì–¸ê¸‰í•´ì£¼ì„¸ìš”.
3. ìœ ì—°í•œ ë¬¸ë²• ê¸°ì¤€: ëŒ€ì†Œë¬¸ì, ë§ˆì¹¨í‘œ, ì‚¬ì†Œí•œ ê´€ì‚¬ ì‹¤ìˆ˜ ë“± íšŒí™”ì—ì„œ ì˜ì‚¬ì†Œí†µì— ì§€ì¥ì´ ì—†ëŠ” ê°€ë²¼ìš´ ë¬¸ë²• ì˜¤ë¥˜ëŠ” ì§€ì í•˜ì§€ ë§ˆì„¸ìš”.
4. ì–´ìƒ‰í•œ ì‚¬ìš© ì§€ì : í•´ë‹¹ ë‹¨ì–´ë¥¼ íšŒí™”ì—ì„œ ê·¸ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ ë§¤ìš° ì–´ìƒ‰í•˜ê±°ë‚˜ ëœ»ì´ ë‹¤ë¥´ê²Œ ì „ë‹¬ë  ë•Œë§Œ ê·¸ ì´ìœ ë¥¼ ê°„ë‹¨ëª…ë£Œí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
5. êµì • ì‹œ í•„ìˆ˜ ê·œì¹™: ì‚¬ìš©ìì˜ ë¬¸ì¥ì´ ì–´ìƒ‰í•´ì„œ êµì •í•´ì¤„ ë•ŒëŠ” ë‹¤ë¥¸ ë‹¨ì–´ë¡œ ì•„ì˜ˆ êµì²´í•´ë²„ë¦¬ì§€ ë§ê³ , **ë°˜ë“œì‹œ ì œì‹œëœ ë‹¨ì–´('${wordData.word}')ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì„œ** ìì—°ìŠ¤ëŸ¬ìš´ ì˜ˆë¬¸ìœ¼ë¡œ ê³ ì³ì£¼ì„¸ìš”.
6. ê°„ê²°ì„± ë° í˜•ì‹: ë¶ˆí•„ìš”í•œ ì¸ì‚¬ë§(ì•ˆë…•í•˜ì„¸ìš”, ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤ ë“±)ì€ ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”. ì˜¤ì§ ì‘ì„±ëœ ë¬¸ì¥ë“¤ì— ëŒ€í•œ í”¼ë“œë°±ë§Œ í•µì‹¬ì ìœ¼ë¡œ ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ ì œê³µí•˜ì„¸ìš”.

[ë°˜ë“œì‹œ ì•„ë˜ì˜ ì¶œë ¥ í¬ë§·ì„ ì—„ê²©í•˜ê²Œ ì§€ì¼œì£¼ì„¸ìš”]
ê° ë¬¸ì¥ë§ˆë‹¤ ì•„ë˜ í¬ë§·ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”. ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸(*, ëŒ€ê´„í˜¸, ìƒµ ë“±)ëŠ” ì¼ì ˆ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

ë¬¸ì¥ [ë²ˆí˜¸]: [ì‚¬ìš©ìê°€ ì‘ì„±í•œ ì›ë³¸ ë¬¸ì¥]
[í”¼ë“œë°± ë‚´ìš© (ì™„ë²½í•˜ë©´ "ì™„ë²½í•˜ê²Œ ì˜ í™œìš©í•˜ì…¨ìŠµë‹ˆë‹¤!", ì–´ìƒ‰í•˜ë©´ ì´ìœ  ì„¤ëª…)]
(ì–´ìƒ‰í•œ ê²½ìš°ì—ë§Œ) ì˜ˆì‹œ: [í•´ë‹¹ ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ êµì •ëœ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥]

(ì˜ˆì‹œ ë‹µë³€)
ë¬¸ì¥ 1: it was an accident
ì™„ë²½í•˜ê²Œ ì˜ í™œìš©í•˜ì…¨ìŠµë‹ˆë‹¤!

ë¬¸ì¥ 2: the accident is kind
'accident'ëŠ” 'ì‚¬ê³ ' ë˜ëŠ” 'ìš°ì—°í•œ ì¼'ì„ ì˜ë¯¸í•˜ëŠ”ë°, 'kind' (ì¹œì ˆí•œ)ë¼ëŠ” í˜•ìš©ì‚¬ëŠ” ë³´í†µ ì‚¬ëŒì´ë‚˜ í–‰ë™ì„ ë¬˜ì‚¬í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤. ë”°ë¼ì„œ 'ì‚¬ê³ ê°€ ì¹œì ˆí•˜ë‹¤'ëŠ” ì–´ìƒ‰í•©ë‹ˆë‹¤.
ì˜ˆì‹œ: The accident was minor.
`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const result = await fetchWithBackoff(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const feedbackText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (feedbackText) {
                    const feedbackArea = document.getElementById(`feedback-area-${wordIndex}`);
                    feedbackArea.innerText = feedbackText;
                    feedbackArea.classList.remove('hidden');
                } else {
                    throw new Error("Invalid response");
                }
            } catch (error) {
                console.error("API Error:", error);
                showToast("AI ì„œë²„ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // --- 6. ì•± ì‹œì‘ ---
        function startApp() {
            // ë¡œë” ìˆ¨ê¸°ê¸°
            const loader = document.getElementById('initial-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
            
            selectDailyWords();
            updateHeaderStats();
            renderDashboard();
        }

        window.onload = () => {
            initFirebase();
        };

    </script>
</body>
</html>
